"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –≤ OpenRouter API

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:
1. –ö–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤)
2. –î–ª–∏–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å (—Å—Ä–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤)
3. –û—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤, –±–ª–∏–∑–∫–æ–µ –∫ –ª–∏–º–∏—Ç—É)

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ë–ï–°–ü–õ–ê–¢–ù–ê–Ø –º–æ–¥–µ–ª—å deepseek/deepseek-r1-distill-qwen-14b:free (14B –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
"""

import requests
import json
from dotenv import load_dotenv
import os

# Load environment variables
load_dotenv(dotenv_path='.secrets/openrouter-api-key.env')

OPENROUTER_API_KEY = os.getenv('OPENROUTER_API_KEY')
OPENROUTER_API_URL = 'https://openrouter.ai/api/v1/chat/completions'
# Using DeepSeek R1 Distill Qwen 14B - less popular free model, more stable
MODEL_NAME = 'deepseek/deepseek-r1-distill-qwen-14b:free'  # Free model


def test_openrouter_api(prompt: str, description: str) -> dict:
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ OpenRouter API –∏ –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""

    headers = {
        'Authorization': f'Bearer {OPENROUTER_API_KEY}',
        'Content-Type': 'application/json',
        'HTTP-Referer': 'https://github.com/your-username/telegram-bot',
        'X-Title': 'Token Testing Script'
    }

    payload = {
        "model": MODEL_NAME,
        "messages": [
            {
                "role": "user",
                "content": prompt
            }
        ],
        "temperature": 0.7,
        "max_tokens": 2000
    }

    print(f"\n{'='*60}")
    print(f"üìù {description}")
    print(f"{'='*60}")
    print(f"–ú–æ–¥–µ–ª—å: {MODEL_NAME}")
    print(f"–î–ª–∏–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞: {len(prompt)} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"–ü—Ä–∏–º–µ—Ä–Ω–æ: {len(prompt) // 4} —Ç–æ–∫–µ–Ω–æ–≤ (–æ—Ü–µ–Ω–∫–∞)\n")

    try:
        response = requests.post(OPENROUTER_API_URL, headers=headers, data=json.dumps(payload))
        response.raise_for_status()
        result = response.json()

        # –ò–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
        response_text = result['choices'][0]['message']['content']

        # –ò–∑–≤–ª–µ—á—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–æ–∫–µ–Ω–æ–≤
        usage = result.get('usage', {})
        prompt_tokens = usage.get('prompt_tokens', 0)
        completion_tokens = usage.get('completion_tokens', 0)
        total_tokens = usage.get('total_tokens', 0)

        print(f"‚úÖ –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
        print(f"\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤:")
        print(f"   ‚Ä¢ –í—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–∑–∞–ø—Ä–æ—Å): {prompt_tokens}")
        print(f"   ‚Ä¢ –í—ã—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–æ—Ç–≤–µ—Ç): {completion_tokens}")
        print(f"   ‚Ä¢ –í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤: {total_tokens}")
        print(f"\nüí¨ –û—Ç–≤–µ—Ç (–ø–µ—Ä–≤—ã–µ 150 —Å–∏–º–≤–æ–ª–æ–≤):")
        print(f"   {response_text[:150]}...")
        print(f"\n–ü–æ–ª–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(response_text)} —Å–∏–º–≤–æ–ª–æ–≤")

        return {
            'success': True,
            'total_tokens': total_tokens,
            'prompt_tokens': prompt_tokens,
            'completion_tokens': completion_tokens,
            'response_length': len(response_text)
        }

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
        if hasattr(e, 'response') and e.response is not None:
            print(f"   –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: {e.response.status_code}")
            try:
                error_data = e.response.json()
                print(f"   –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {json.dumps(error_data, indent=2, ensure_ascii=False)}")
            except:
                print(f"   –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {e.response.text}")
        return {
            'success': False,
            'error': str(e)
        }


def main():
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤"""

    print("\n" + "="*60)
    print("üöÄ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –†–ê–ë–û–¢–´ –° –¢–û–ö–ï–ù–ê–ú–ò OPENROUTER API")
    print("   (–ë–ï–°–ü–õ–ê–¢–ù–ê–Ø –ú–û–î–ï–õ–¨ DeepSeek R1 Distill Qwen - 14B)")
    print("="*60)

    # –¢–µ—Å—Ç 1: –ö–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å
    short_prompt = "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"
    test1 = test_openrouter_api(short_prompt, "–¢–ï–°–¢ 1: –ö–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å")

    # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
    import time
    time.sleep(1)

    # –¢–µ—Å—Ç 2: –°—Ä–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å
    medium_prompt = """
    –†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–æ –æ —Ç–æ–º, —á—Ç–æ —Ç–∞–∫–æ–µ —Ç–æ–∫–µ–Ω—ã –≤ —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª—è—Ö.
    –û–±—ä—è—Å–Ω–∏, –∫–∞–∫ –æ–Ω–∏ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –º–æ–¥–µ–ª–∏, –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤,
    –∏ –∫–∞–∫–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö.
    –ü—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã —Ç–æ–≥–æ, –∫–∞–∫ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤.
    """
    test2 = test_openrouter_api(medium_prompt, "–¢–ï–°–¢ 2: –°—Ä–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å")

    time.sleep(1)

    # –¢–µ—Å—Ç 3: –î–ª–∏–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–Ω–æ –Ω–µ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –¥–ª–∏–Ω–Ω—ã–π –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏)
    long_prompt = """
    –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö –Ω–∞—É–∫.

    –ú–Ω–µ –Ω—É–∂–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö —Ç–µ–º:

    1. –ß—Ç–æ —Ç–∞–∫–æ–µ —Ç–æ–∫–µ–Ω—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ –∏ –±–æ–ª—å—à–∏—Ö —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π?
    2. –ö–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞? –ö–∞–∫–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –º–µ—Ç–æ–¥—ã —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–∏?
    3. –ü–æ—á–µ–º—É —Ä–∞–∑–Ω—ã–µ —è–∑—ã–∫–∏ —Ç—Ä–µ–±—É—é—Ç —Ä–∞–∑–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –æ–±—ä—ë–º–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏?
    4. –ö–∞–∫–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö (GPT-3, GPT-4, Claude, Qwen –∏ –¥—Ä—É–≥–∏—Ö)?
    5. –ö–∞–∫ –ª–∏–º–∏—Ç—ã –Ω–∞ —Ç–æ–∫–µ–Ω—ã –≤–ª–∏—è—é—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π?
    6. –ö–∞–∫–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö?
    7. –ö–∞–∫ –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ–∫–µ–Ω–æ–≤?
    8. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤?
    9. –ö–∞–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–ª–∏–Ω–Ω—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–º–µ—â–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ–∫–Ω–æ –º–æ–¥–µ–ª–∏?
    10. –ö–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞?

    –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏.
    –¢–∞–∫–∂–µ –ø—Ä–∏–≤–µ–¥–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å —è–∑—ã–∫–æ–≤—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏.
    """

    test3 = test_openrouter_api(long_prompt, "–¢–ï–°–¢ 3: –î–ª–∏–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å")

    # –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print("\n" + "="*60)
    print("üìà –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê")
    print("="*60)

    if test1.get('success'):
        print(f"\n‚úÖ –¢–µ—Å—Ç 1 (–∫–æ—Ä–æ—Ç–∫–∏–π): {test1['total_tokens']} —Ç–æ–∫–µ–Ω–æ–≤")
        print(f"   –ó–∞–ø—Ä–æ—Å: {test1['prompt_tokens']}, –û—Ç–≤–µ—Ç: {test1['completion_tokens']}")
    else:
        print(f"\n‚ùå –¢–µ—Å—Ç 1 (–∫–æ—Ä–æ—Ç–∫–∏–π): –û–®–ò–ë–ö–ê")

    if test2.get('success'):
        print(f"\n‚úÖ –¢–µ—Å—Ç 2 (—Å—Ä–µ–¥–Ω–∏–π): {test2['total_tokens']} —Ç–æ–∫–µ–Ω–æ–≤")
        print(f"   –ó–∞–ø—Ä–æ—Å: {test2['prompt_tokens']}, –û—Ç–≤–µ—Ç: {test2['completion_tokens']}")
    else:
        print(f"\n‚ùå –¢–µ—Å—Ç 2 (—Å—Ä–µ–¥–Ω–∏–π): –û–®–ò–ë–ö–ê")

    if test3.get('success'):
        print(f"\n‚úÖ –¢–µ—Å—Ç 3 (–¥–ª–∏–Ω–Ω—ã–π): {test3['total_tokens']} —Ç–æ–∫–µ–Ω–æ–≤")
        print(f"   –ó–∞–ø—Ä–æ—Å: {test3['prompt_tokens']}, –û—Ç–≤–µ—Ç: {test3['completion_tokens']}")
    else:
        print(f"\n‚ùå –¢–µ—Å—Ç 3 (–¥–ª–∏–Ω–Ω—ã–π): –û–®–ò–ë–ö–ê - {test3.get('error', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}")

    print("\n" + "="*60)
    print("üéØ –í–´–í–û–î–´:")
    print("="*60)
    print("""
    1. –ö–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –º–∏–Ω–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ (–æ–±—ã—á–Ω–æ 10-50)
    2. –°—Ä–µ–¥–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —É–º–µ—Ä–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (100-500)
    3. –î–ª–∏–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 500-2000+ —Ç–æ–∫–µ–Ω–æ–≤
    4. –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å DeepSeek R1 Distill Qwen —á–µ—Ä–µ–∑ OpenRouter –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç!
    5. –í–∞–∂–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –º–æ–¥–µ–ª–∏
    6. OpenRouter –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ç–æ–∫–µ–Ω–∞–º –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ
    """)
    print("="*60 + "\n")


if __name__ == "__main__":
    if not OPENROUTER_API_KEY:
        print("‚ùå –û—à–∏–±–∫–∞: –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENROUTER_API_KEY")
        print("   –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .secrets/openrouter-api-key.env —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:")
        print("   OPENROUTER_API_KEY=your_api_key_here")
        print("\n   –ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π API –∫–ª—é—á –º–æ–∂–Ω–æ –Ω–∞ https://openrouter.ai/")
    else:
        main()
